{% extends 'base.html' %}
{% load form_filters %}

{% block title %}Ticket List{% endblock %}

{% block content %}
<!-- 検索フォーム -->
<div class="mb-4">
  <form method="get" action="{% url 'tickets' %}" class="row g-3">
      <div class="col-md-2">
          <label for="id_status" class="form-label">Status</label>
          {{ form.status|add_class:"form-select" }}
      </div>
      <div class="col-md-2">
          <label for="id_category" class="form-label">Category</label>
          {{ form.category|add_class:"form-control" }}
      </div>
      <div class="col-md-2">
          <label for="id_companies" class="form-label">Companies</label>
          <input type="hidden" name="company_ids" id="company_ids" value="{{ form.company_ids.value|default_if_none:'' }}">
          <button type="button" class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#companyModal">Select Companies</button>
          <span id="selected_companies" class="ms-2"></span>
      </div>
      <div class="col-md-12">
          <button type="submit" class="btn btn-primary">Search</button>
          <a href="{% url 'tickets' %}" class="btn btn-secondary">Reset</a>
      </div>
  </form>
</div>

<!-- Modal -->
<div class="modal fade" id="companyModal" tabindex="-1" aria-labelledby="companyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="companyModalLabel">Select Companies</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="list-group">
            {% for company in companies %}
                <a href="#" class="list-group-item list-group-item-action">
                    <input type="checkbox" class="company-checkbox" data-id="{{ company.id }}" data-name="{{ company.name }}"> {{ company.name }}
                </a>
            {% endfor %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="save_companies">Save</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<div class="container">
    <h2 class="my-4">Tickets for Project: {{ project.name }}</h2>

    <!-- Ticket List -->
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>Title</th>
          <th>Status</th>
          <th>Category</th>
          <th>Company</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Deadline</th>
        </tr>
      </thead>
      <tbody>
        {% for ticket in tickets %}
          <tr>
            <td>
              <a href="{% url 'ticket_detail' ticket.id %}">{{ ticket.title }}</a>
            </td>
            <td>
              <span class="badge bg-secondary">
                {% if ticket.status_id == 10 %}
                  未処理
                {% elif ticket.status_id == 20 %}
                  保留
                {% elif ticket.status_id == 30 %}
                  確認中
                {% elif ticket.status_id == 40 %}
                  処理中
                {% elif ticket.status_id == 50 %}
                  完了
                {% else %}
                  不明
                {% endif %}
              </span>
            </td>
            <td>{{ ticket.category.name }}</td>
            <td>
              {% for company in ticket.companies.all %}
                <span class="badge bg-info text-dark">{{ company.name }}</span>
              {% empty %}
                <span class="badge bg-light text-dark"></span>
              {% endfor %}
            </td>
            <td>{{ ticket.start_date|date:'Y-m-d' }}</td>
            <td>{{ ticket.end_date|date:'Y-m-d' }}</td>
            <td>{{ ticket.deadline|date:'Y-m-d' }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7">No tickets available.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <!-- JavaScript -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $(document).ready(function() {
      // モーダルが表示されるたびに選択状態を更新
      $('#companyModal').on('show.bs.modal', function() {
          var selectedCompanies = $('#company_ids').val().split(',');
          $('.company-checkbox').each(function() {
              $(this).prop('checked', selectedCompanies.includes($(this).data('id').toString()));
          });
      });
  
      // 「Save」ボタンがクリックされたときの処理
      $('#save_companies').on('click', function() {
          var selectedCompanies = [];
          var companyNames = [];
  
          $('.company-checkbox:checked').each(function() {
              selectedCompanies.push($(this).data('id'));
              companyNames.push($(this).data('name'));
          });
  
          $('#company_ids').val(selectedCompanies.join(','));
          $('#selected_companies').text(companyNames.join(', '));
  
          var modal = bootstrap.Modal.getInstance(document.getElementById('companyModal'));
          modal.hide(); // モーダルを隠す
  
          // モーダルのオーバーレイを強制的に削除
          $('.modal-backdrop').remove();
      });
  });
    </script>
{% endblock %}
