{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2>    <a href="{% url 'ticket_list' pk=project.id %}" class="btn btn-primary"><i class="fa-regular fa-circle-left"></i></a> {{ project.name }} - Gantt Chart</h2>

    <!-- ガントチャート用のSVG -->
    <div class="gantt-wrap">
        <svg id="gantt"></svg>
    </div>

    <!-- Frappe GanttのCSSとスクリプト -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.min.js"></script>
    <script>
        window.onload = function() {
            try {
                const chartData = JSON.parse('{{ chart_data|escapejs }}');
    
                // ステータスIDに基づいて色を設定するためのマッピング
                const statusColors = {
                    10: 'rgba(255, 99, 132, 0.6)',  // 未処理: 赤
                    20: 'rgba(54, 162, 235, 0.6)',  // 保留: 黄色
                    30: 'rgba(255, 206, 86, 0.6)',  // 確認中: 緑
                    40: 'rgba(75, 192, 192, 0.6)',  // 処理中: 明るい緑
                    50: 'rgba(55, 55, 50, 0.6)'   // 完了: 青
                };
    
                // Frappe Gantt用のタスクデータに変換
                const tasks = chartData.map(ticket => ({
                    id: ticket.title,
                    name: ticket.title,
                    start: ticket.start,
                    end: ticket.end,
                    progress: 0,
                    ticket_id: ticket.ticket_id,
                    custom_class: `status-${ticket.status_id}`  // カスタムクラスを設定
                }));
    
                const gantt = new Gantt("#gantt", tasks, {
                    view_mode: 'Day',
                    date_format: 'YYYY-MM-DD',
                    custom_popup_html: function(task) {
                        return `
                            <div class="popover-header">${task.name}</div>
                            <div class="popover-body">
                                <p>Start: ${task.start}</p>
                                <p>End: ${task.end}</p>
                            </div>
                        `;
                    },
                    on_click: function(task) {
                        // クリックされたタスクの詳細画面に遷移
                        const detailUrl = `/ticket/${task.ticket_id}/`;  // 適切なURLに変更してください
                        window.location.href = detailUrl;
                    },
                    on_date_change: function(task, start, end) {
                        updateTaskInDatabase(task.id, start, end);
                    },
                    on_progress_change: function(task, progress) {
                        updateTaskProgressInDatabase(task.id, progress);
                    }
                });
    
                // CSSを動的に追加して、カスタムクラスに色を適用
                const style = document.createElement('style');
                document.head.appendChild(style);
                const sheet = style.sheet;
                Object.keys(statusColors).forEach(status_id => {
                    sheet.insertRule(`
                        .gantt .status-${status_id} .bar {
                            fill: ${statusColors[status_id]};
                        }
                    `, sheet.cssRules.length);
                });
    
                function updateTaskInDatabase(taskId, startDate, endDate) {
                    // Date オブジェクトを ISO 形式の文字列に変換
                    const startDateString = new Date(startDate).toISOString().split('T')[0];
                    const endDateString = new Date(endDate).toISOString().split('T')[0];
                    
                    fetch('/update-task/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            id: taskId,
                            start_date: startDateString,
                            end_date: endDateString
                        })
                    })
                    .then(response => response.json())
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while updating the task.');
                    });
                }
    
                function updateTaskProgressInDatabase(taskId, progress) {
                    fetch('/update-task-progress/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({
                            id: taskId,
                            progress: progress
                        })
                    })
                    .then(response => response.json())
                    .catch(error => {
                        console.error('Error:', error);
                    });
                }
    
                // CSRFトークンをテンプレートから直接渡す
                const csrfToken = '{{ csrf_token }}';
            } catch (error) {
                console.error("Error parsing chart data:", error);
            }
        };
    </script>
    
</div>
{% endblock %}
